{{ define "book" }}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ .Book.Title }} - Highlights</title>
    <script src="https://unpkg.com/htmx.org@2.0.4"></script>
    <link rel="stylesheet" href="/static/style.css">
    {{ if .Auth.CSRFToken }}
    <meta name="csrf-token" content="{{ .Auth.CSRFToken }}">
    {{ end }}
</head>
<body>
    <div class="container">
        <header>
            <div class="header-row">
                <h1><a href="/">Highlights</a></h1>
                {{ if .Auth.Enabled }}
                <div class="user-menu">
                    {{ if .Auth.LoggedIn }}
                    <span class="user-name">{{ .Auth.Username }}</span>
                    <a href="/profile" class="profile-link">Profile</a>
                    <a href="/logout" class="logout-link">Logout</a>
                    {{ else }}
                    <a href="/login" class="login-link">Login</a>
                    {{ end }}
                </div>
                {{ end }}
            </div>
            <nav>
                <a href="/">Books</a>
                <a href="/favourites">Favourites</a>
                <a href="/vocabulary">Vocabulary</a>
                <a href="/settings">Settings</a>
            </nav>
        </header>
        <a href="/" class="back-link">← Back to books</a>

        <div class="book-header">
            <div class="book-header-top">
                <div class="book-header-left">
                    {{ if .Book.CoverURL }}
                    <img src="/api/books/{{ .Book.ID }}/cover" alt="Book cover" class="book-cover">
                    {{ end }}
                    <div class="book-header-info">
                        <h2>{{ .Book.Title }}</h2>
                        <div class="author">{{ .Book.Author }}</div>
                        <div class="book-meta">
                            {{ len .Book.Highlights }} highlights
                            {{ if .Book.Source.DisplayName }}
                            <span class="source-badge">{{ .Book.Source.DisplayName }}</span>
                            {{ else if .Book.Source.Name }}
                            <span class="source-badge">{{ .Book.Source.Name }}</span>
                            {{ end }}
                        </div>
                        {{ if or .Book.Publisher .Book.PublicationYear .Book.ISBN }}
                        <div class="book-details">
                            {{ if .Book.Publisher }}<span>{{ .Book.Publisher }}</span>{{ end }}
                            {{ if .Book.PublicationYear }}<span>{{ .Book.PublicationYear }}</span>{{ end }}
                            {{ if .Book.ISBN }}<span class="isbn">ISBN: {{ .Book.ISBN }}</span>{{ end }}
                        </div>
                        {{ end }}
                    </div>
                </div>
                <div class="book-actions">
                    <a href="/ui/books/{{ .Book.ID }}/download" class="download-btn" title="Download as Markdown">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    </a>
                    <div class="delete-dropdown" id="book-delete-dropdown">
                        <button type="button" class="delete-btn" onclick="toggleDeleteDropdown('book-delete-dropdown')" title="Delete book">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                        </button>
                        <div class="delete-dropdown-menu">
                            <button type="button" class="delete-option"
                                    hx-delete="/api/books/{{ .Book.ID }}"
                                    hx-confirm="Delete this book? It can be restored later."
                                    hx-on::after-request="window.location.href='/'">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                                Delete
                            </button>
                            <button type="button" class="delete-option delete-option-permanent"
                                    hx-delete="/api/books/{{ .Book.ID }}/permanent"
                                    hx-confirm="Permanently delete this book? This cannot be undone and will prevent re-importing."
                                    hx-on::after-request="window.location.href='/'">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg>
                                Delete Forever
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tags-section" id="book-tags-section">
            <h3>Tags</h3>
            <div id="book-tags-container">
                {{ template "book-tags" . }}
            </div>
        </div>

        <div class="metadata-section" id="metadata-section">
            <h3>Book Metadata</h3>
            <div class="metadata-actions">
                <form class="isbn-form" hx-patch="/api/books/{{ .Book.ID }}/isbn" hx-target="#enrichment-result" hx-swap="innerHTML">
                    <input type="text" name="isbn" placeholder="Enter ISBN" value="{{ .Book.ISBN }}" class="form-input isbn-input">
                    <button type="button" class="btn btn-primary"
                            hx-post="/api/books/{{ .Book.ID }}/enrich"
                            hx-target="#enrichment-result"
                            hx-swap="innerHTML"
                            hx-include="[name='isbn']">
                        <span class="htmx-indicator"><span class="spinner"></span></span>
                        {{ if or .Book.CoverURL .Book.Publisher .Book.PublicationYear }}
                        Refresh Metadata
                        {{ else }}
                        Enrich Metadata
                        {{ end }}
                    </button>
                </form>
            </div>
            <div id="enrichment-result"></div>
        </div>

        <div class="highlights">
            {{ range .Book.Highlights }}
            <div class="highlight" id="highlight-{{ .ID }}">
                <div class="highlight-header">
                    <div class="highlight-text">{{ .Text }}</div>
                    <div class="highlight-actions">
                        <div id="favourite-btn-{{ .ID }}">
                            {{ template "favourite-button" . }}
                        </div>
                        <div class="delete-dropdown" id="highlight-delete-{{ .ID }}">
                        <button type="button" class="delete-btn delete-btn-small" onclick="toggleDeleteDropdown('highlight-delete-{{ .ID }}')" title="Delete highlight">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                        </button>
                        <div class="delete-dropdown-menu">
                            <button type="button" class="delete-option"
                                    hx-delete="/api/highlights/{{ .ID }}"
                                    hx-target="#highlight-{{ .ID }}"
                                    hx-swap="outerHTML"
                                    hx-confirm="Delete this highlight? It can be restored later.">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                                Delete
                            </button>
                            <button type="button" class="delete-option delete-option-permanent"
                                    hx-delete="/api/highlights/{{ .ID }}/permanent"
                                    hx-target="#highlight-{{ .ID }}"
                                    hx-swap="outerHTML"
                                    hx-confirm="Permanently delete this highlight? This cannot be undone and will prevent re-importing.">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg>
                                Delete Forever
                            </button>
                        </div>
                    </div>
                    </div>
                </div>
                {{ if .Note }}
                <div class="highlight-note">{{ .Note }}</div>
                {{ end }}
                {{ if or .Chapter (gt .Page 0) (gt .LocationValue 0) }}
                <div class="highlight-meta">
                    {{ if .Chapter }}Chapter: {{ .Chapter }}{{ end }}
                    {{ if gt .Page 0 }}
                        {{ if .Chapter }} · {{ end }}
                        Page: {{ .Page }}
                    {{ else if gt .LocationValue 0 }}
                        {{ if .Chapter }} · {{ end }}
                        {{ if and .LocationType (ne .LocationType "none") }}{{ .LocationType }}{{ else }}Page{{ end }}: {{ .LocationValue }}
                    {{ end }}
                </div>
                {{ end }}
                <div class="highlight-tags-container" id="highlight-tags-{{ .ID }}">
                    {{ template "highlight-tags" . }}
                </div>
            </div>
            {{ else }}
            <div class="empty-state">No highlights yet</div>
            {{ end }}
        </div>
    </div>

    <script>
    function toggleDeleteDropdown(id) {
        const dropdown = document.getElementById(id);
        const wasOpen = dropdown.classList.contains('open');

        // Close all dropdowns first
        document.querySelectorAll('.delete-dropdown.open').forEach(d => {
            d.classList.remove('open');
        });

        // Toggle the clicked one
        if (!wasOpen) {
            dropdown.classList.add('open');
        }
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.delete-dropdown')) {
            document.querySelectorAll('.delete-dropdown.open').forEach(d => {
                d.classList.remove('open');
            });
        }
    });

    // Word selection functionality for vocabulary
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.highlight-text').forEach(function(el) {
            el.addEventListener('mouseup', function(e) {
                // Remove any existing popover first
                document.querySelectorAll('.word-popover').forEach(p => p.remove());

                const selection = window.getSelection();
                const text = selection.toString().trim();

                // Only show popover for single words or short phrases
                if (text && text.length > 0 && text.length < 50 && !text.includes('\n')) {
                    showAddWordPopover(e, text, el);
                }
            });
        });
    });

    function showAddWordPopover(event, word, highlightEl) {
        const highlightDiv = highlightEl.closest('.highlight');
        const highlightId = highlightDiv ? highlightDiv.id.replace('highlight-', '') : null;

        const popover = document.createElement('div');
        popover.className = 'word-popover';
        popover.innerHTML = `
            <div class="popover-content">
                <span class="popover-word">"${word}"</span>
                <button type="button" class="btn btn-small btn-primary" onclick="addWordToVocabulary('${word.replace(/'/g, "\\'")}', ${highlightId})">
                    Add to Vocabulary
                </button>
                <button type="button" class="btn btn-small" onclick="this.closest('.word-popover').remove()">
                    Cancel
                </button>
            </div>
        `;

        popover.style.position = 'absolute';
        popover.style.left = event.pageX + 'px';
        popover.style.top = (event.pageY + 10) + 'px';

        document.body.appendChild(popover);

        // Close on click outside after a short delay
        setTimeout(() => {
            document.addEventListener('click', function closePopover(e) {
                if (!popover.contains(e.target)) {
                    popover.remove();
                    document.removeEventListener('click', closePopover);
                }
            });
        }, 100);
    }

    function addWordToVocabulary(word, highlightId) {
        const body = {
            word: word,
            auto_enrich: true
        };
        if (highlightId) {
            body.highlight_id = parseInt(highlightId);
        }

        const headers = {
            'Content-Type': 'application/json',
        };
        const csrfMeta = document.querySelector('meta[name="csrf-token"]');
        if (csrfMeta) {
            headers['X-CSRF-Token'] = csrfMeta.content;
        }

        fetch('/api/vocabulary', {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(body)
        })
        .then(response => response.json())
        .then(data => {
            document.querySelectorAll('.word-popover').forEach(p => p.remove());
            if (data.error) {
                if (data.error === 'word already exists') {
                    showNotification('Word already in vocabulary', 'info');
                } else {
                    showNotification('Error: ' + data.error, 'error');
                }
            } else {
                showNotification('Added "' + word + '" to vocabulary');
            }
        })
        .catch(err => {
            showNotification('Error adding word: ' + err, 'error');
        });
    }

    function showNotification(message, type = 'success') {
        const notification = document.createElement('div');
        notification.className = 'notification notification-' + type;
        notification.textContent = message;
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 3000);
    }

    // Configure HTMX to include CSRF token in all non-GET requests
    document.body.addEventListener('htmx:configRequest', function(evt) {
        const csrfMeta = document.querySelector('meta[name="csrf-token"]');
        if (csrfMeta && evt.detail.verb !== 'get') {
            evt.detail.headers['X-CSRF-Token'] = csrfMeta.content;
        }
    });
    </script>
</body>
</html>
{{ end }}

{{ define "book-tags" }}
<div class="tags-list">
    {{ if .Book.Tags }}
    {{ range .Book.Tags }}
    <span class="tag-chip">
        {{ .Name }}
        <button type="button" class="tag-remove"
                hx-delete="/api/books/{{ $.Book.ID }}/tags/{{ .ID }}"
                hx-target="#book-tags-container"
                hx-swap="innerHTML"
                title="Remove tag">×</button>
    </span>
    {{ end }}
    {{ end }}
    <div class="tag-add-form">
        <input type="text"
               name="q"
               placeholder="Add tag..."
               class="tag-input"
               autocomplete="off"
               hx-get="/api/tags/suggest"
               hx-trigger="input changed delay:200ms"
               hx-target="#tag-suggestions-{{ .Book.ID }}"
               hx-swap="innerHTML">
        <div id="tag-suggestions-{{ .Book.ID }}" class="tag-suggestions"></div>
        <button type="button" id="add-tag-btn-{{ .Book.ID }}" class="btn btn-small btn-secondary"
                hx-post="/api/books/{{ .Book.ID }}/tags"
                hx-target="#book-tags-container"
                hx-swap="innerHTML"
                hx-include="[name='q']"
                hx-trigger="click, keydown[key=='Enter'] from:previous input">Add</button>
    </div>
</div>
{{ end }}

{{ define "highlight-tags" }}
<div class="highlight-tags">
    {{ if .Tags }}
    {{ range .Tags }}
    <span class="tag-chip tag-chip-small">
        {{ .Name }}
        <button type="button" class="tag-remove"
                hx-delete="/api/highlights/{{ $.ID }}/tags/{{ .ID }}"
                hx-target="#highlight-tags-{{ $.ID }}"
                hx-swap="innerHTML"
                title="Remove tag">×</button>
    </span>
    {{ end }}
    {{ end }}
    <div class="tag-add-inline">
        <input type="text"
               name="tag_name"
               placeholder="+ tag"
               class="tag-input tag-input-small"
               autocomplete="off">
        <button type="button" class="tag-add-btn"
                hx-post="/api/highlights/{{ .ID }}/tags"
                hx-target="#highlight-tags-{{ .ID }}"
                hx-swap="innerHTML"
                hx-include="closest .tag-add-inline"
                hx-trigger="click, keydown[key=='Enter'] from:previous input"
                title="Add tag">+</button>
    </div>
</div>
{{ end }}

{{ define "tag-suggestions" }}
{{ if . }}
<div class="tag-dropdown">
    {{ range . }}
    <button type="button" class="tag-suggestion"
            onclick="const form = this.closest('.tag-add-form'); const input = form.querySelector('input[name=q]'); input.value='{{ .Name }}'; this.closest('.tag-suggestions').innerHTML=''; form.querySelector('button[hx-post]').click();">
        {{ .Name }}
    </button>
    {{ end }}
</div>
{{ end }}
{{ end }}

{{ define "delete-success" }}
<!-- Empty div to replace the deleted element -->
{{ end }}

{{ define "favourite-button" }}
{{ if .IsFavorite }}
<button type="button" class="favourite-btn favourite-btn-active" title="Remove from favourites"
        hx-delete="/api/highlights/{{ .ID }}/favourite"
        hx-target="#favourite-btn-{{ .ID }}"
        hx-swap="innerHTML">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
</button>
{{ else }}
<button type="button" class="favourite-btn" title="Add to favourites"
        hx-post="/api/highlights/{{ .ID }}/favourite"
        hx-target="#favourite-btn-{{ .ID }}"
        hx-swap="innerHTML">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
</button>
{{ end }}
{{ end }}
