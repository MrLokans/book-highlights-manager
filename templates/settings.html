{{ define "settings" }}
<!DOCTYPE html>
<html lang="en">
<head>
    {{ template "base-head" . }}
    <title>Settings - Highlights</title>
</head>
<body>
    {{ template "demo-banner" . }}
    <div class="container">
        {{ template "header-settings" . }}

        <h2 class="page-title">Settings</h2>

        <div class="settings-tabs-container">
            <nav class="settings-tabs">
                <button class="settings-tab active" data-tab="integrations">
                    <svg class="settings-tab-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M18 20V10"/>
                        <path d="M12 20V4"/>
                        <path d="M6 20v-6"/>
                    </svg>
                    Integrations
                </button>
                <button class="settings-tab" data-tab="exports">
                    <svg class="settings-tab-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                        <polyline points="10 9 9 9 8 9"/>
                    </svg>
                    Exports
                </button>
                <button class="settings-tab" data-tab="admin">
                    <svg class="settings-tab-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                    Admin
                </button>
                <button class="settings-tab" data-tab="analytics">
                    <svg class="settings-tab-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="20" x2="18" y2="10"/>
                        <line x1="12" y1="20" x2="12" y2="4"/>
                        <line x1="6" y1="20" x2="6" y2="14"/>
                    </svg>
                    Analytics
                </button>
            </nav>

            <div class="settings-tab-content">
                <div id="tab-integrations" class="settings-tab-panel active">
                    <section class="settings-section">
                        <h3>Integrations</h3>

                        <div class="integration-card">
                <div class="integration-header">
                    <div class="integration-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.6 0 12 0zm-2.2 17.8l-3.4-3.4 1.4-1.4 2 2 5.6-5.6 1.4 1.4-7 7z"/>
                        </svg>
                    </div>
                    <div class="integration-info">
                        <h4>Dropbox</h4>
                        <p class="integration-desc">Sync Moon+ Reader highlights from Dropbox</p>
                    </div>
                </div>

                {{ if not .DropboxConfigured }}
                <div class="integration-status status-error">
                    <span class="status-icon">!</span>
                    <span>App Key not configured. Set DROPBOX_APP_KEY environment variable.</span>
                </div>
                {{ else }}
                <div id="dropbox-status-container">
                    {{ template "dropbox-status" .DropboxStatus }}
                </div>
                {{ end }}
            </div>

            <div class="integration-card">
                <div class="integration-header">
                    <div class="integration-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                        </svg>
                    </div>
                    <div class="integration-info">
                        <h4>Readwise API</h4>
                        <p class="integration-desc">Automatically sync highlights from Readwise on a schedule</p>
                    </div>
                </div>

                <div id="readwise-sync-container"
                    hx-get="/settings/readwise"
                    hx-trigger="load"
                    hx-swap="innerHTML">
                    <div class="integration-status status-info">
                        <span class="status-dot info"></span>
                        <span class="status-text">Loading Readwise sync settings...</span>
                    </div>
                </div>
            </div>

            <div class="integration-card">
                <div class="integration-header">
                    <div class="integration-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                        </svg>
                    </div>
                    <div class="integration-info">
                        <h4>Readwise CSV</h4>
                        <p class="integration-desc">Import highlights from Readwise CSV export</p>
                    </div>
                </div>

                <div class="integration-status status-info">
                    <span class="status-dot info"></span>
                    <span class="status-text">Upload your Readwise CSV export file</span>
                </div>
                <div class="integration-actions">
                    <form
                        hx-post="/settings/readwise/import-csv"
                        hx-target="#readwise-csv-result-container"
                        hx-swap="innerHTML"
                        hx-encoding="multipart/form-data"
                        hx-indicator="#readwise-csv-indicator"
                    >
                        <div class="file-upload-container">
                            <input type="file" name="csv_file" id="readwise-csv-file" accept=".csv" required>
                            <label for="readwise-csv-file" class="file-upload-label">Choose CSV file</label>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <span id="readwise-csv-indicator" class="htmx-indicator">
                                <span class="spinner"></span>
                            </span>
                            Import CSV
                        </button>
                    </form>
                </div>
                <div id="readwise-csv-result-container"></div>
            </div>

            <div class="integration-card">
                <div class="integration-header">
                    <div class="integration-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M21 5c-1.11-.35-2.33-.5-3.5-.5-1.95 0-4.05.4-5.5 1.5-1.45-1.1-3.55-1.5-5.5-1.5S2.45 4.9 1 6v14.65c0 .25.25.5.5.5.1 0 .15-.05.25-.05C3.1 20.45 5.05 20 6.5 20c1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.3 4.75 1.05.1.05.15.05.25.05.25 0 .5-.25.5-.5V6c-.6-.45-1.25-.75-2-1zm0 13.5c-1.1-.35-2.3-.5-3.5-.5-1.7 0-4.15.65-5.5 1.5V8c1.35-.85 3.8-1.5 5.5-1.5 1.2 0 2.4.15 3.5.5v11.5z"/>
                        </svg>
                    </div>
                    <div class="integration-info">
                        <h4>Apple Books</h4>
                        <p class="integration-desc">Import highlights from Apple Books SQLite databases</p>
                    </div>
                </div>

                <div class="integration-status status-info">
                    <span class="status-dot info"></span>
                    <span class="status-text">Upload your Apple Books database files from macOS</span>
                </div>
                <details class="integration-help">
                    <summary>How to find your Apple Books databases</summary>
                    <div class="help-content">
                        <p>On macOS, your Apple Books databases are located at:</p>
                        <ul>
                            <li><strong>Annotations:</strong> <code>~/Library/Containers/com.apple.iBooksX/Data/Documents/AEAnnotation/*.sqlite</code></li>
                            <li><strong>Books:</strong> <code>~/Library/Containers/com.apple.iBooksX/Data/Documents/BKLibrary/*.sqlite</code></li>
                        </ul>
                        <p>You can access these folders in Finder by pressing <kbd>Cmd+Shift+G</kbd> and pasting the path.</p>
                    </div>
                </details>
                <div class="integration-actions">
                    <form
                        hx-post="/settings/applebooks/import"
                        hx-target="#applebooks-result-container"
                        hx-swap="innerHTML"
                        hx-encoding="multipart/form-data"
                        hx-indicator="#applebooks-indicator"
                    >
                        <div class="file-upload-group">
                            <div class="file-upload-container">
                                <label class="file-upload-title">Annotation Database</label>
                                <input type="file" name="annotation_db" id="applebooks-annotation-file" accept=".sqlite,.db" required>
                                <label for="applebooks-annotation-file" class="file-upload-label">Choose annotation .sqlite</label>
                            </div>
                            <div class="file-upload-container">
                                <label class="file-upload-title">Book Database</label>
                                <input type="file" name="book_db" id="applebooks-book-file" accept=".sqlite,.db" required>
                                <label for="applebooks-book-file" class="file-upload-label">Choose book .sqlite</label>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <span id="applebooks-indicator" class="htmx-indicator">
                                <span class="spinner"></span>
                            </span>
                            Import from Apple Books
                        </button>
                    </form>
                </div>
                <div id="applebooks-result-container"></div>
            </div>

            <div class="integration-card">
                <div class="integration-header">
                    <div class="integration-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M17.5 4.5c-1.95 0-4.05.4-5.5 1.5-1.45-1.1-3.55-1.5-5.5-1.5-1.45 0-2.99.22-4.28.79C1.49 5.62 1 6.33 1 7.14v11.28c0 1.3 1.22 2.26 2.48 1.94.98-.25 2.02-.36 3.02-.36 1.56 0 3.22.26 4.56.92.6.3 1.28.3 1.88 0 1.34-.67 3-.92 4.56-.92 1 0 2.04.11 3.02.36 1.26.33 2.48-.63 2.48-1.94V7.14c0-.81-.49-1.52-1.22-1.85-1.29-.57-2.83-.79-4.28-.79zM21 17.23c0 .63-.58 1.09-1.2.98-.75-.14-1.53-.21-2.3-.21-1.7 0-4.15.65-5.5 1.5V8c1.35-.85 3.8-1.5 5.5-1.5.92 0 1.83.09 2.7.28.46.1.8.51.8.98v9.47z"/>
                        </svg>
                    </div>
                    <div class="integration-info">
                        <h4>Kindle</h4>
                        <p class="integration-desc">Import highlights from Kindle 'My Clippings.txt'</p>
                    </div>
                </div>

                <div class="integration-status status-info">
                    <span class="status-dot info"></span>
                    <span class="status-text">Upload your Kindle clippings file</span>
                </div>
                <details class="integration-help">
                    <summary>How to find your Kindle clippings file</summary>
                    <div class="help-content">
                        <p>When your Kindle is connected to your computer, the clippings file is located at:</p>
                        <ul>
                            <li><strong>macOS:</strong> <code>/Volumes/Kindle/documents/My Clippings.txt</code></li>
                            <li><strong>Windows:</strong> <code>D:\documents\My Clippings.txt</code> (drive letter may vary)</li>
                            <li><strong>Linux:</strong> <code>/media/&lt;user&gt;/Kindle/documents/My Clippings.txt</code></li>
                        </ul>
                        <p>This file contains all your highlights, notes, and bookmarks from all books on your Kindle device.</p>
                    </div>
                </details>
                <div class="integration-actions">
                    <form
                        hx-post="/settings/kindle/import"
                        hx-target="#kindle-result-container"
                        hx-swap="innerHTML"
                        hx-encoding="multipart/form-data"
                        hx-indicator="#kindle-indicator"
                    >
                        <div class="file-upload-container">
                            <input type="file" name="clippings_file" id="kindle-clippings-file" accept=".txt" required>
                            <label for="kindle-clippings-file" class="file-upload-label">Choose My Clippings.txt</label>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <span id="kindle-indicator" class="htmx-indicator">
                                <span class="spinner"></span>
                            </span>
                            Import from Kindle
                        </button>
                    </form>
                </div>
                <div id="kindle-result-container"></div>
            </div>
                    </section>
                </div>

                <div id="tab-exports" class="settings-tab-panel">
                    <section class="settings-section">
                        <h3>Exports</h3>

                        <div class="integration-card">
                            <div class="integration-header">
                                <div class="integration-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="12" cy="12" r="10"/>
                                        <polyline points="12 6 12 12 16 14"/>
                                    </svg>
                                </div>
                                <div class="integration-info">
                                    <h4>Periodic Obsidian Sync</h4>
                                    <p class="integration-desc">Automatically export highlights to Obsidian on a schedule</p>
                                </div>
                            </div>

                            <div id="obsidian-sync-container"
                                hx-get="/settings/obsidian"
                                hx-trigger="load"
                                hx-swap="innerHTML">
                                <div class="integration-status status-info">
                                    <span class="status-dot info"></span>
                                    <span class="status-text">Loading sync settings...</span>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>

                <div id="tab-admin" class="settings-tab-panel">
                    <section class="settings-section">
                        <h3>Administrative Tasks</h3>

                        <div class="integration-card">
                            <div class="integration-header">
                                <div class="integration-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                        <polyline points="14 2 14 8 20 8"/>
                                        <line x1="16" y1="13" x2="8" y2="13"/>
                                        <line x1="16" y1="17" x2="8" y2="17"/>
                                        <polyline points="10 9 9 9 8 9"/>
                                    </svg>
                                </div>
                                <div class="integration-info">
                                    <h4>Audit Log</h4>
                                    <p class="integration-desc">View a log of all application events (imports, deletes, settings changes)</p>
                                </div>
                            </div>

                            <div class="integration-status status-info">
                                <span class="status-dot info"></span>
                                <span class="status-text">Events are retained for 30 days</span>
                            </div>
                            <div class="integration-actions">
                                <a href="/audit" class="btn btn-primary">View Audit Log</a>
                            </div>
                        </div>

                        <div class="integration-card">
                            <div class="integration-header">
                                <div class="integration-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="12" cy="12" r="10"/>
                                        <line x1="12" y1="8" x2="12" y2="12"/>
                                        <line x1="12" y1="16" x2="12.01" y2="16"/>
                                    </svg>
                                </div>
                                <div class="integration-info">
                                    <h4>Sync Book Metadata</h4>
                                    <p class="integration-desc">Fetch missing metadata (covers, publishers, publication years) from OpenLibrary for all books</p>
                                </div>
                            </div>

                            <div class="integration-status status-info">
                                <span class="status-dot info"></span>
                                <span class="status-text">This will process all books missing cover images, publisher info, or publication year</span>
                            </div>
                            <div class="integration-actions">
                                <div id="sync-status" hx-get="/api/sync/metadata/status" hx-trigger="load" hx-swap="outerHTML">
                                    <button
                                        class="btn btn-primary"
                                        hx-post="/api/books/enrich-all"
                                        hx-target="#sync-status"
                                        hx-swap="outerHTML"
                                        hx-confirm="This will fetch metadata for all books missing data. Continue?"
                                    >
                                        Sync All Missing Metadata
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="integration-card">
                            <div class="integration-header">
                                <div class="integration-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/>
                                        <line x1="7" y1="7" x2="7.01" y2="7"/>
                                    </svg>
                                </div>
                                <div class="integration-info">
                                    <h4>Cleanup Orphan Tags</h4>
                                    <p class="integration-desc">Remove tags that are not associated with any books or highlights</p>
                                </div>
                            </div>

                            <div class="integration-status status-info">
                                <span class="status-dot info"></span>
                                <span class="status-text">This will permanently delete unused tags from the database</span>
                            </div>
                            <div class="integration-actions">
                                <div id="tags-cleanup-container">
                                    <button
                                        class="btn btn-primary"
                                        hx-post="/api/admin/tags/cleanup"
                                        hx-target="#tags-cleanup-container"
                                        hx-swap="innerHTML"
                                        hx-indicator="#tags-cleanup-indicator"
                                        hx-confirm="This will delete all tags not linked to any book or highlight. Continue?"
                                    >
                                        <span id="tags-cleanup-indicator" class="htmx-indicator">
                                            <span class="spinner"></span>
                                        </span>
                                        Cleanup Orphan Tags
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="integration-card">
                            <div class="integration-header">
                                <div class="integration-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <rect x="2" y="7" width="20" height="14" rx="2" ry="2"/>
                                        <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>
                                    </svg>
                                </div>
                                <div class="integration-info">
                                    <h4>Background Tasks</h4>
                                    <p class="integration-desc">Manually trigger background tasks</p>
                                </div>
                            </div>

                            <div class="integration-status status-info">
                                <span class="status-dot info"></span>
                                <span class="status-text">{{ if .TasksEnabled }}Task queue is running with {{ .TaskWorkers }} workers{{ else }}Task queue is disabled{{ end }}</span>
                            </div>
                            {{ if .TasksEnabled }}
                            <div class="integration-actions">
                                <div id="task-enrich-book-container">
                                    <div class="task-action-row">
                                        <form
                                            hx-post="/api/tasks/enrich_book/run"
                                            hx-target="#task-enrich-book-result"
                                            hx-swap="innerHTML"
                                            hx-indicator="#task-enrich-book-indicator"
                                            class="task-form"
                                        >
                                            <input type="number" name="book_id" placeholder="Book ID" class="form-input task-input" required min="1">
                                            <button type="submit" class="btn btn-secondary">
                                                <span id="task-enrich-book-indicator" class="htmx-indicator">
                                                    <span class="spinner"></span>
                                                </span>
                                                Enrich Single Book
                                            </button>
                                        </form>
                                    </div>
                                    <div id="task-enrich-book-result"></div>
                                </div>
                                <div id="task-enrich-all-container" style="margin-top: 0.5rem;">
                                    <button
                                        class="btn btn-secondary"
                                        hx-post="/api/tasks/enrich_all_books/run"
                                        hx-target="#task-enrich-all-result"
                                        hx-swap="innerHTML"
                                        hx-indicator="#task-enrich-all-indicator"
                                        hx-confirm="This will enqueue enrichment tasks for all books missing metadata. Continue?"
                                    >
                                        <span id="task-enrich-all-indicator" class="htmx-indicator">
                                            <span class="spinner"></span>
                                        </span>
                                        Enqueue All Missing (via Task Queue)
                                    </button>
                                    <div id="task-enrich-all-result"></div>
                                </div>
                            </div>
                            {{ end }}
                        </div>
                    </section>
                </div>

                <div id="tab-analytics" class="settings-tab-panel">
                    <section class="settings-section">
                        <h3>Analytics</h3>

                        <div class="integration-card">
                            <div class="integration-header">
                                <div class="integration-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <line x1="18" y1="20" x2="18" y2="10"/>
                                        <line x1="12" y1="20" x2="12" y2="4"/>
                                        <line x1="6" y1="20" x2="6" y2="14"/>
                                    </svg>
                                </div>
                                <div class="integration-info">
                                    <h4>Plausible Analytics</h4>
                                    <p class="integration-desc">Privacy-friendly website analytics</p>
                                </div>
                            </div>

                            <div id="analytics-settings-container"
                                hx-get="/settings/analytics"
                                hx-trigger="load"
                                hx-swap="innerHTML">
                                <div class="integration-status status-info">
                                    <span class="status-dot info"></span>
                                    <span class="status-text">Loading analytics settings...</span>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </div>

        <script>
            document.querySelectorAll('.settings-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.settings-tab-panel').forEach(p => p.classList.remove('active'));

                    tab.classList.add('active');
                    const tabId = tab.getAttribute('data-tab');
                    document.getElementById('tab-' + tabId).classList.add('active');
                });
            });

        </script>
        {{ template "scripts-common" . }}
    </div>
</body>
</html>
{{ end }}

{{ define "dropbox-status" }}
{{ if .Connected }}
<div class="integration-status status-connected">
    <span class="status-dot connected"></span>
    <div class="status-details">
        <span class="status-text">Connected</span>
        {{ if .DisplayName }}
        <span class="status-account">{{ .DisplayName }}</span>
        {{ else if .Email }}
        <span class="status-account">{{ .Email }}</span>
        {{ else if .AccountID }}
        <span class="status-account">{{ .AccountID }}</span>
        {{ end }}
        {{ if .IsExpired }}
        <span class="status-warning">Token expired - reconnect required</span>
        {{ end }}
    </div>
</div>
<div class="integration-actions">
    {{ if not .IsExpired }}
    <button
        class="btn btn-primary"
        hx-post="/settings/moonreader/import"
        hx-target="#import-result-container"
        hx-swap="innerHTML"
        hx-indicator="#import-indicator"
    >
        <span id="import-indicator" class="htmx-indicator">
            <span class="spinner"></span>
        </span>
        Import Moon+ Reader Backup
    </button>
    {{ end }}
    <button
        class="btn btn-secondary"
        hx-post="/settings/oauth/dropbox/check"
        hx-target="#dropbox-status-container"
        hx-swap="innerHTML"
        hx-indicator="#dropbox-check-indicator"
    >
        <span id="dropbox-check-indicator" class="htmx-indicator">
            <span class="spinner"></span>
        </span>
        Check Token
    </button>
    <button
        class="btn btn-danger"
        hx-post="/settings/oauth/dropbox/disconnect"
        hx-target="#dropbox-status-container"
        hx-swap="innerHTML"
        hx-confirm="Are you sure you want to disconnect Dropbox?"
    >
        Disconnect
    </button>
</div>
<div id="import-result-container"></div>
{{ else }}
<div class="integration-status status-disconnected">
    <span class="status-dot disconnected"></span>
    <span class="status-text">Not connected</span>
</div>
<div class="integration-actions">
    <form action="/settings/oauth/dropbox/init" method="POST">
        <button type="submit" class="btn btn-primary">
            Connect Dropbox
        </button>
    </form>
</div>
{{ end }}
{{ end }}

{{ define "settings-callback" }}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dropbox Authorization - Highlights</title>
    <link rel="stylesheet" href="/static/style.css">
    {{ if .Success }}
    <meta http-equiv="refresh" content="3;url=/settings">
    {{ end }}
</head>
<body>
    <div class="container">
        <header>
            <h1><a href="/">Highlights</a></h1>
            <nav>
                <a href="/">Books</a>
                <a href="/settings">Settings</a>
            </nav>
        </header>

        <div class="callback-result">
            {{ if .Success }}
            <div class="callback-success">
                <div class="callback-icon success">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                        <polyline points="22 4 12 14.01 9 11.01"/>
                    </svg>
                </div>
                <h2>Dropbox Connected!</h2>
                <p>Successfully connected to Dropbox account.</p>
                {{ if .AccountID }}
                <p class="account-id">Account: {{ .AccountID }}</p>
                {{ end }}
                <p class="redirect-notice">Redirecting to settings...</p>
                <a href="/settings" class="btn btn-primary">Go to Settings</a>
            </div>
            {{ else }}
            <div class="callback-error">
                <div class="callback-icon error">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="15" y1="9" x2="9" y2="15"/>
                        <line x1="9" y1="9" x2="15" y2="15"/>
                    </svg>
                </div>
                <h2>Authorization Failed</h2>
                <p class="error-message">{{ .Error }}</p>
                <a href="/settings" class="btn btn-primary">Back to Settings</a>
            </div>
            {{ end }}
        </div>
    </div>
</body>
</html>
{{ end }}

{{ define "settings-error" }}
<div class="integration-status status-error">
    <span class="status-icon">!</span>
    <span>{{ .Error }}</span>
</div>
{{ end }}

{{ define "import-result" }}
{{ if .Success }}
<div class="import-result import-success">
    <div class="import-result-header">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
        </svg>
        <span>Import Successful</span>
    </div>
    <div class="import-stats">
        <div class="import-stat">
            <span class="stat-value">{{ .Highlights }}</span>
            <span class="stat-label">highlights</span>
        </div>
        <div class="import-stat">
            <span class="stat-value">{{ .BooksImported }}</span>
            <span class="stat-label">books imported</span>
        </div>
        <div class="import-stat">
            <span class="stat-value">{{ .BooksExported }}</span>
            <span class="stat-label">books exported</span>
        </div>
    </div>
    {{ if .Errors }}
    <div class="import-warnings">
        <strong>Warnings:</strong>
        <ul>
            {{ range .Errors }}
            <li>{{ . }}</li>
            {{ end }}
        </ul>
    </div>
    {{ end }}
</div>
{{ else }}
<div class="import-result import-error">
    <div class="import-result-header">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"/>
            <line x1="15" y1="9" x2="9" y2="15"/>
            <line x1="9" y1="9" x2="15" y2="15"/>
        </svg>
        <span>Import Failed</span>
    </div>
    <p class="import-error-message">{{ .Error }}</p>
</div>
{{ end }}
{{ end }}

{{ define "readwise-csv-import-result" }}
{{ if .Success }}
<div class="import-result import-success">
    <div class="import-result-header">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
        </svg>
        <span>CSV Import Successful</span>
    </div>
    <div class="import-stats">
        <div class="import-stat">
            <span class="stat-value">{{ .TotalRows }}</span>
            <span class="stat-label">rows processed</span>
        </div>
        <div class="import-stat">
            <span class="stat-value">{{ .BooksImported }}</span>
            <span class="stat-label">books</span>
        </div>
        <div class="import-stat">
            <span class="stat-value">{{ .HighlightsImported }}</span>
            <span class="stat-label">highlights</span>
        </div>
    </div>
    {{ if .Errors }}
    <div class="import-warnings">
        <strong>Warnings:</strong>
        <ul>
            {{ range .Errors }}
            <li>{{ . }}</li>
            {{ end }}
        </ul>
    </div>
    {{ end }}
</div>
{{ else }}
<div class="import-result import-error">
    <div class="import-result-header">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"/>
            <line x1="15" y1="9" x2="9" y2="15"/>
            <line x1="9" y1="9" x2="15" y2="15"/>
        </svg>
        <span>Import Failed</span>
    </div>
    <p class="import-error-message">{{ .Error }}</p>
</div>
{{ end }}
{{ end }}

{{ define "applebooks-import-result" }}
{{ if .Success }}
<div class="import-result import-success">
    <div class="import-result-header">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
        </svg>
        <span>Apple Books Import Successful</span>
    </div>
    <div class="import-stats">
        <div class="import-stat">
            <span class="stat-value">{{ .BooksImported }}</span>
            <span class="stat-label">books</span>
        </div>
        <div class="import-stat">
            <span class="stat-value">{{ .HighlightsImported }}</span>
            <span class="stat-label">highlights</span>
        </div>
    </div>
    {{ if .Errors }}
    <div class="import-warnings">
        <strong>Warnings:</strong>
        <ul>
            {{ range .Errors }}
            <li>{{ . }}</li>
            {{ end }}
        </ul>
    </div>
    {{ end }}
</div>
{{ else }}
<div class="import-result import-error">
    <div class="import-result-header">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"/>
            <line x1="15" y1="9" x2="9" y2="15"/>
            <line x1="9" y1="9" x2="15" y2="15"/>
        </svg>
        <span>Import Failed</span>
    </div>
    <p class="import-error-message">{{ .Error }}</p>
</div>
{{ end }}
{{ end }}

{{ define "kindle-import-result" }}
{{ if .Success }}
<div class="import-result import-success">
    <div class="import-result-header">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
        </svg>
        <span>Kindle Import Successful</span>
    </div>
    <div class="import-stats">
        <div class="import-stat">
            <span class="stat-value">{{ .BooksImported }}</span>
            <span class="stat-label">books</span>
        </div>
        <div class="import-stat">
            <span class="stat-value">{{ .HighlightsImported }}</span>
            <span class="stat-label">highlights</span>
        </div>
    </div>
    {{ if .Errors }}
    <div class="import-warnings">
        <strong>Warnings:</strong>
        <ul>
            {{ range .Errors }}
            <li>{{ . }}</li>
            {{ end }}
        </ul>
    </div>
    {{ end }}
</div>
{{ else }}
<div class="import-result import-error">
    <div class="import-result-header">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"/>
            <line x1="15" y1="9" x2="9" y2="15"/>
            <line x1="9" y1="9" x2="15" y2="15"/>
        </svg>
        <span>Import Failed</span>
    </div>
    <p class="import-error-message">{{ .Error }}</p>
</div>
{{ end }}
{{ end }}

{{ define "task-run-result" }}
{{ if .Success }}
<div class="import-result import-success" style="margin-top: 0.5rem;">
    <div class="import-result-header">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
        </svg>
        <span>Task Enqueued</span>
    </div>
    <p class="task-id">Task ID: {{ .TaskID }}</p>
</div>
{{ else }}
<div class="import-result import-error" style="margin-top: 0.5rem;">
    <div class="import-result-header">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"/>
            <line x1="15" y1="9" x2="9" y2="15"/>
            <line x1="9" y1="9" x2="15" y2="15"/>
        </svg>
        <span>Failed</span>
    </div>
    <p class="import-error-message">{{ .Error }}</p>
</div>
{{ end }}
{{ end }}

{{ define "tags-cleanup-result" }}
{{ if .Success }}
<div class="import-result import-success">
    <div class="import-result-header">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
        </svg>
        <span>Cleanup Complete</span>
    </div>
    <div class="import-stats">
        <div class="import-stat">
            <span class="stat-value">{{ .Deleted }}</span>
            <span class="stat-label">tags removed</span>
        </div>
    </div>
</div>
{{ else }}
<div class="import-result import-error">
    <div class="import-result-header">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"/>
            <line x1="15" y1="9" x2="9" y2="15"/>
            <line x1="9" y1="9" x2="15" y2="15"/>
        </svg>
        <span>Cleanup Failed</span>
    </div>
    <p class="import-error-message">{{ .Error }}</p>
</div>
{{ end }}
{{ end }}

{{ define "analytics-settings" }}
<div class="analytics-settings">
    {{ if .Settings.Enabled }}
    <div class="integration-status status-success">
        <span class="status-dot success"></span>
        <span class="status-text">Analytics enabled for {{ .Settings.Domain }}</span>
    </div>
    {{ else }}
    <div class="integration-status status-info">
        <span class="status-dot info"></span>
        <span class="status-text">Analytics is currently disabled</span>
    </div>
    {{ end }}

    <form
        hx-post="/settings/analytics/save"
        hx-target="#analytics-settings-container"
        hx-swap="innerHTML"
        hx-indicator="#analytics-save-indicator"
        class="analytics-form"
    >
        <div class="form-group checkbox-group">
            <label class="checkbox-label">
                <input type="checkbox" name="enabled" value="true" {{ if .Settings.Enabled }}checked{{ end }}>
                <span>Enable Plausible Analytics</span>
            </label>
            {{ if eq .Settings.EnabledSource "environment" }}
            <span class="badge badge-info badge-sm">From ENV</span>
            {{ else if eq .Settings.EnabledSource "database" }}
            <span class="badge badge-success badge-sm">Saved</span>
            {{ end }}
        </div>

        <div class="form-group">
            <label for="plausible-domain">Domain</label>
            <div class="input-with-badge">
                <input
                    type="text"
                    id="plausible-domain"
                    name="domain"
                    value="{{ .Settings.Domain }}"
                    placeholder="example.com"
                    class="form-input"
                >
                {{ if eq .Settings.DomainSource "database" }}
                <span class="badge badge-success">Saved</span>
                {{ else if eq .Settings.DomainSource "environment" }}
                <span class="badge badge-info">From ENV</span>
                {{ end }}
            </div>
            <small class="form-help">The domain you registered in Plausible (e.g., demo.highlights.app)</small>
        </div>

        <div class="form-group">
            <label for="plausible-script-url">Script URL (Advanced)</label>
            <div class="input-with-badge">
                <input
                    type="text"
                    id="plausible-script-url"
                    name="script_url"
                    value="{{ .Settings.ScriptURL }}"
                    placeholder="https://plausible.io/js/script.js"
                    class="form-input"
                >
                {{ if eq .Settings.ScriptURLSource "database" }}
                <span class="badge badge-success">Saved</span>
                {{ else if eq .Settings.ScriptURLSource "environment" }}
                <span class="badge badge-info">From ENV</span>
                {{ else }}
                <span class="badge badge-default">Default</span>
                {{ end }}
            </div>
            <small class="form-help">Use the default unless you're self-hosting Plausible</small>
        </div>

        <div class="form-group">
            <label>Script Extensions</label>
            <div class="checkbox-grid">
                {{ range $ext := .ValidExtensions }}
                <label class="checkbox-label">
                    <input type="checkbox" name="ext_{{ $ext }}" value="{{ $ext }}"
                        {{ range $.Settings.Extensions }}{{ if eq . $ext }}checked{{ end }}{{ end }}>
                    <span>{{ $ext }}</span>
                </label>
                {{ end }}
            </div>
            <small class="form-help">
                <a href="https://plausible.io/docs/script-extensions" target="_blank" rel="noopener">Learn about extensions</a>
            </small>
        </div>

        <div class="integration-actions">
            <button type="submit" class="btn btn-primary">
                <span id="analytics-save-indicator" class="htmx-indicator">
                    <span class="spinner"></span>
                </span>
                Save Settings
            </button>
            <button
                type="button"
                class="btn btn-secondary"
                hx-post="/settings/analytics/clear"
                hx-target="#analytics-settings-container"
                hx-swap="innerHTML"
                hx-confirm="Reset to environment defaults? This will clear all saved analytics settings."
            >
                Reset to Defaults
            </button>
        </div>
    </form>

    {{ if .Settings.Enabled }}
    <div class="script-preview" style="margin-top: 1rem;">
        <label>Generated Script Tag:</label>
        <pre class="code-preview"><code>&lt;script defer data-domain="{{ .Settings.Domain }}" src="{{ .Settings.ScriptURL }}"&gt;&lt;/script&gt;</code></pre>
    </div>
    {{ end }}
</div>
{{ end }}

{{ define "analytics-result" }}
{{ if .Success }}
<div class="analytics-settings">
    <div class="import-result import-success" style="margin-bottom: 1rem;">
        <div class="import-result-header">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                <polyline points="22 4 12 14.01 9 11.01"/>
            </svg>
            <span>Analytics settings saved</span>
        </div>
    </div>
    {{ template "analytics-settings-form" . }}
</div>
{{ else }}
<div class="analytics-settings">
    <div class="import-result import-error" style="margin-bottom: 1rem;">
        <div class="import-result-header">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <line x1="15" y1="9" x2="9" y2="15"/>
                <line x1="9" y1="9" x2="15" y2="15"/>
            </svg>
            <span>{{ .Error }}</span>
        </div>
    </div>
</div>
{{ end }}
{{ end }}

{{ define "analytics-preview" }}
<div class="script-preview">
    {{ if .Enabled }}
    <p>Script tag preview for <strong>{{ .Domain }}</strong>:</p>
    <pre class="code-preview"><code>{{ .ScriptTag }}</code></pre>
    {{ else }}
    <p>Analytics is disabled. Enable it and set a domain to see the script tag.</p>
    {{ end }}
</div>
{{ end }}

{{ define "obsidian-sync-settings" }}
<div class="obsidian-sync-settings">
    {{ if .Config.Enabled }}
    <div class="integration-status status-success">
        <span class="status-dot success"></span>
        <span class="status-text">Sync enabled - {{ .Config.Schedule }}</span>
    </div>
    {{ else }}
    <div class="integration-status status-info">
        <span class="status-dot info"></span>
        <span class="status-text">Periodic sync is disabled</span>
    </div>
    {{ end }}

    {{ if .Status.LastSyncAt }}
    <div class="sync-status-info" style="margin: 0.75rem 0; padding: 0.75rem; background: var(--surface-secondary); border-radius: var(--radius-md);">
        <div class="sync-last-run">
            <strong>Last sync:</strong>
            {{ if eq .Status.Status "success" }}
            <span class="status-dot success" style="display: inline-block; margin-left: 0.5rem;"></span>
            {{ else if eq .Status.Status "failed" }}
            <span class="status-dot error" style="display: inline-block; margin-left: 0.5rem;"></span>
            {{ end }}
            <span>{{ .Status.LastSyncAt }}</span>
        </div>
        {{ if .Status.Message }}
        <div class="sync-message" style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.25rem;">
            {{ .Status.Message }}
        </div>
        {{ end }}
    </div>
    {{ end }}

    {{ if and .IsRunning .NextRun }}
    <div class="sync-next-run" style="margin-bottom: 0.75rem; font-size: 0.875rem; color: var(--text-secondary);">
        <strong>Next sync:</strong> {{ .NextRun }}
    </div>
    {{ end }}

    <form
        hx-post="/settings/obsidian/save"
        hx-target="#obsidian-sync-container"
        hx-swap="innerHTML"
        hx-indicator="#obsidian-sync-indicator"
        class="obsidian-sync-form"
    >
        <div class="form-group checkbox-group">
            <label class="checkbox-label">
                <input type="checkbox" name="enabled" value="true" {{ if .Config.Enabled }}checked{{ end }}>
                <span>Enable periodic sync</span>
            </label>
            {{ if eq .Config.EnabledSource "environment" }}
            <span class="badge badge-info badge-sm">From ENV</span>
            {{ else if eq .Config.EnabledSource "database" }}
            <span class="badge badge-success badge-sm">Saved</span>
            {{ end }}
        </div>

        <div class="form-group">
            <label for="obsidian-export-dir">Export Directory</label>
            <div class="input-with-badge">
                <input
                    type="text"
                    id="obsidian-export-dir"
                    name="export_dir"
                    value="{{ .Config.ExportDir }}"
                    placeholder="/path/to/obsidian/vault"
                    class="form-input"
                    hx-post="/settings/obsidian/validate-directory"
                    hx-trigger="blur changed delay:500ms"
                    hx-target="#export-dir-validation"
                    hx-swap="innerHTML"
                >
                {{ if eq .Config.ExportDirSource "database" }}
                <span class="badge badge-success">Saved</span>
                {{ else if eq .Config.ExportDirSource "environment" }}
                <span class="badge badge-info">From ENV</span>
                {{ else }}
                <span class="badge badge-default">Not Set</span>
                {{ end }}
            </div>
            <div id="export-dir-validation"></div>
            {{ if and (eq .Config.ExportDirSource "environment") .EnvExportDir }}
            <small class="form-help">Environment: {{ .EnvExportDir }}</small>
            {{ else if eq .Config.ExportDirSource "default" }}
            <small class="form-help">No export directory configured. Set OBSIDIAN_EXPORT_DIR or enter a path above.</small>
            {{ end }}
        </div>

        <div class="form-group">
            <label for="obsidian-sync-schedule">Schedule</label>
            <select
                id="obsidian-sync-schedule"
                name="schedule"
                class="form-input"
            >
                {{ range .Presets }}
                <option value="{{ .Value }}" {{ if eq .Value $.Config.Schedule }}selected{{ end }}>{{ .Label }}</option>
                {{ end }}
            </select>
            {{ if eq .Config.ScheduleSource "database" }}
            <span class="badge badge-success badge-sm">Saved</span>
            {{ else if eq .Config.ScheduleSource "environment" }}
            <span class="badge badge-info badge-sm">From ENV</span>
            {{ end }}
            <small class="form-help">
                {{ range .Presets }}{{ if eq .Value $.Config.Schedule }}{{ .Description }}{{ end }}{{ end }}
            </small>
        </div>

        <div class="integration-actions">
            <button type="submit" class="btn btn-primary">
                <span id="obsidian-sync-indicator" class="htmx-indicator">
                    <span class="spinner"></span>
                </span>
                Save Settings
            </button>
            <button
                type="button"
                class="btn btn-secondary"
                hx-post="/settings/obsidian/sync-now"
                hx-target="#obsidian-sync-container"
                hx-swap="innerHTML"
                hx-indicator="#sync-now-indicator"
                {{ if not .Config.ExportDir }}disabled title="Configure export directory first"{{ end }}
            >
                <span id="sync-now-indicator" class="htmx-indicator">
                    <span class="spinner"></span>
                </span>
                Sync Now
            </button>
            <button
                type="button"
                class="btn btn-secondary"
                hx-post="/settings/obsidian/reset"
                hx-target="#obsidian-sync-container"
                hx-swap="innerHTML"
                hx-confirm="Reset to environment defaults? This will clear all saved sync settings."
            >
                Reset to Defaults
            </button>
        </div>
    </form>
</div>
{{ end }}

{{ define "obsidian-sync-result" }}
{{ if .Success }}
<div class="obsidian-sync-settings">
    <div class="import-result import-success" style="margin-bottom: 1rem;">
        <div class="import-result-header">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                <polyline points="22 4 12 14.01 9 11.01"/>
            </svg>
            <span>{{ if .Message }}{{ .Message }}{{ else }}Settings saved{{ end }}</span>
        </div>
    </div>
    <div hx-get="/settings/obsidian" hx-trigger="load" hx-swap="outerHTML"></div>
</div>
{{ else }}
<div class="obsidian-sync-settings">
    <div class="import-result import-error" style="margin-bottom: 1rem;">
        <div class="import-result-header">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <line x1="15" y1="9" x2="9" y2="15"/>
                <line x1="9" y1="9" x2="15" y2="15"/>
            </svg>
            <span>{{ .Error }}</span>
        </div>
    </div>
    <div hx-get="/settings/obsidian" hx-trigger="load" hx-swap="outerHTML"></div>
</div>
{{ end }}
{{ end }}

{{ define "obsidian-sync-status" }}
<div class="sync-status-panel">
    {{ if .status.LastSyncAt }}
    <div class="sync-last-run">
        <strong>Last sync:</strong>
        {{ if eq .status.Status "success" }}
        <span class="status-dot success" style="display: inline-block;"></span>
        {{ else if eq .status.Status "failed" }}
        <span class="status-dot error" style="display: inline-block;"></span>
        {{ end }}
        <span>{{ .status.LastSyncAt }}</span>
    </div>
    {{ if .status.Message }}
    <div class="sync-message">{{ .status.Message }}</div>
    {{ end }}
    {{ end }}
    {{ if and .is_running .next_run }}
    <div class="sync-next-run">
        <strong>Next sync:</strong> {{ .next_run }}
    </div>
    {{ end }}
</div>
{{ end }}

{{ define "readwise-sync-settings" }}
<div class="readwise-sync-settings">
    {{ if .Config.Enabled }}
    <div class="integration-status status-success">
        <span class="status-dot success"></span>
        <span class="status-text">Sync enabled - {{ .Config.Schedule }}</span>
    </div>
    {{ else if .Config.HasToken }}
    <div class="integration-status status-info">
        <span class="status-dot info"></span>
        <span class="status-text">Token configured, sync disabled</span>
    </div>
    {{ else }}
    <div class="integration-status status-warning">
        <span class="status-dot warning"></span>
        <span class="status-text">No API token configured</span>
    </div>
    {{ end }}

    {{ if .Status.LastSyncAt }}
    <div class="sync-status-info" style="margin: 0.75rem 0; padding: 0.75rem; background: var(--surface-secondary); border-radius: var(--radius-md);">
        <div class="sync-last-run">
            <strong>Last sync:</strong>
            {{ if eq .Status.Status "success" }}
            <span class="status-dot success" style="display: inline-block; margin-left: 0.5rem;"></span>
            {{ else if eq .Status.Status "failed" }}
            <span class="status-dot error" style="display: inline-block; margin-left: 0.5rem;"></span>
            {{ else if eq .Status.Status "running" }}
            <span class="status-dot warning" style="display: inline-block; margin-left: 0.5rem;"></span>
            {{ end }}
            <span>{{ .Status.LastSyncAt }}</span>
        </div>
        {{ if .Status.Message }}
        <div class="sync-message" style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.25rem;">
            {{ .Status.Message }}
        </div>
        {{ end }}
        {{ if and (gt .Status.HighlightsSynced 0) (eq .Status.Status "success") }}
        <div class="sync-stats" style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.25rem;">
            <strong>{{ .Status.HighlightsSynced }}</strong> highlights synced
        </div>
        {{ end }}
    </div>
    {{ end }}

    {{ if and .IsRunning .NextRun }}
    <div class="sync-next-run" style="margin-bottom: 0.75rem; font-size: 0.875rem; color: var(--text-secondary);">
        <strong>Next sync:</strong> {{ .NextRun }}
    </div>
    {{ end }}

    {{ if .IsSyncing }}
    <div class="sync-in-progress" style="margin-bottom: 0.75rem; padding: 0.75rem; background: var(--warning-bg); border-radius: var(--radius-md);">
        <span class="spinner" style="display: inline-block; margin-right: 0.5rem;"></span>
        <span>Sync in progress...</span>
    </div>
    {{ end }}

    <form
        hx-post="/settings/readwise/save"
        hx-target="#readwise-sync-container"
        hx-swap="innerHTML"
        hx-indicator="#readwise-sync-indicator"
        class="readwise-sync-form"
    >
        <div class="form-group checkbox-group">
            <label class="checkbox-label">
                <input type="checkbox" name="enabled" value="true" {{ if .Config.Enabled }}checked{{ end }}>
                <span>Enable periodic sync</span>
            </label>
            {{ if eq .Config.EnabledSource "environment" }}
            <span class="badge badge-info badge-sm">From ENV</span>
            {{ else if eq .Config.EnabledSource "database" }}
            <span class="badge badge-success badge-sm">Saved</span>
            {{ end }}
        </div>

        <div class="form-group">
            <label for="readwise-token">API Token</label>
            <div class="input-with-badge">
                <input
                    type="password"
                    id="readwise-token"
                    name="token"
                    value=""
                    placeholder="{{ if .Config.HasToken }}{{ .Config.Token }}{{ else }}Enter your Readwise API token{{ end }}"
                    class="form-input"
                >
                {{ if eq .Config.TokenSource "database" }}
                <span class="badge badge-success">Saved</span>
                {{ else if eq .Config.TokenSource "environment" }}
                <span class="badge badge-info">From ENV</span>
                {{ else }}
                <span class="badge badge-default">Not Set</span>
                {{ end }}
            </div>
            <div id="token-validation-result"></div>
            <small class="form-help">
                Get your token from <a href="https://readwise.io/access_token" target="_blank" rel="noopener">readwise.io/access_token</a>.
                {{ if .Config.HasToken }}Leave blank to keep current token.{{ end }}
            </small>
        </div>

        <div class="form-group">
            <label for="readwise-sync-schedule">Schedule</label>
            <select
                id="readwise-sync-schedule"
                name="schedule"
                class="form-input"
            >
                {{ range .Presets }}
                <option value="{{ .Value }}" {{ if eq .Value $.Config.Schedule }}selected{{ end }}>{{ .Label }}</option>
                {{ end }}
            </select>
            {{ if eq .Config.ScheduleSource "database" }}
            <span class="badge badge-success badge-sm">Saved</span>
            {{ else if eq .Config.ScheduleSource "environment" }}
            <span class="badge badge-info badge-sm">From ENV</span>
            {{ end }}
            <small class="form-help">
                {{ range .Presets }}{{ if eq .Value $.Config.Schedule }}{{ .Description }}{{ end }}{{ end }}
            </small>
        </div>

        <div class="integration-actions">
            <button type="submit" class="btn btn-primary">
                <span id="readwise-sync-indicator" class="htmx-indicator">
                    <span class="spinner"></span>
                </span>
                Save Settings
            </button>
            <button
                type="button"
                class="btn btn-secondary"
                hx-post="/settings/readwise/validate-token"
                hx-target="#token-validation-result"
                hx-swap="innerHTML"
                hx-indicator="#validate-token-indicator"
                hx-include="#readwise-token"
                {{ if not .Config.HasToken }}disabled title="Configure token first"{{ end }}
            >
                <span id="validate-token-indicator" class="htmx-indicator">
                    <span class="spinner"></span>
                </span>
                Validate Token
            </button>
            <button
                type="button"
                class="btn btn-secondary"
                hx-post="/settings/readwise/sync-now"
                hx-target="#readwise-sync-container"
                hx-swap="innerHTML"
                hx-indicator="#sync-now-indicator"
                {{ if or (not .Config.HasToken) .IsSyncing }}disabled title="{{ if not .Config.HasToken }}Configure token first{{ else }}Sync in progress{{ end }}"{{ end }}
            >
                <span id="sync-now-indicator" class="htmx-indicator">
                    <span class="spinner"></span>
                </span>
                Sync Now
            </button>
            <button
                type="button"
                class="btn btn-secondary"
                hx-post="/settings/readwise/reset"
                hx-target="#readwise-sync-container"
                hx-swap="innerHTML"
                hx-confirm="Reset to environment defaults? This will clear all saved Readwise sync settings including the token."
            >
                Reset to Defaults
            </button>
        </div>
    </form>
</div>
{{ end }}

{{ define "readwise-sync-result" }}
{{ if .Success }}
<div class="readwise-sync-settings">
    <div class="import-result import-success" style="margin-bottom: 1rem;">
        <div class="import-result-header">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                <polyline points="22 4 12 14.01 9 11.01"/>
            </svg>
            <span>{{ if .Message }}{{ .Message }}{{ else }}Settings saved{{ end }}</span>
        </div>
    </div>
    <div hx-get="/settings/readwise" hx-trigger="load" hx-swap="outerHTML"></div>
</div>
{{ else }}
<div class="readwise-sync-settings">
    <div class="import-result import-error" style="margin-bottom: 1rem;">
        <div class="import-result-header">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <line x1="15" y1="9" x2="9" y2="15"/>
                <line x1="9" y1="9" x2="15" y2="15"/>
            </svg>
            <span>{{ .Error }}</span>
        </div>
    </div>
    <div hx-get="/settings/readwise" hx-trigger="load" hx-swap="outerHTML"></div>
</div>
{{ end }}
{{ end }}

{{ define "readwise-sync-status" }}
<div class="sync-status-panel">
    {{ if .status.LastSyncAt }}
    <div class="sync-last-run">
        <strong>Last sync:</strong>
        {{ if eq .status.Status "success" }}
        <span class="status-dot success" style="display: inline-block;"></span>
        {{ else if eq .status.Status "failed" }}
        <span class="status-dot error" style="display: inline-block;"></span>
        {{ else if eq .status.Status "running" }}
        <span class="status-dot warning" style="display: inline-block;"></span>
        {{ end }}
        <span>{{ .status.LastSyncAt }}</span>
    </div>
    {{ if .status.Message }}
    <div class="sync-message">{{ .status.Message }}</div>
    {{ end }}
    {{ end }}
    {{ if .is_syncing }}
    <div class="sync-in-progress">
        <span class="spinner"></span> Sync in progress...
    </div>
    {{ else if and .is_running .next_run }}
    <div class="sync-next-run">
        <strong>Next sync:</strong> {{ .next_run }}
    </div>
    {{ end }}
</div>
{{ end }}

{{ define "readwise-token-validation" }}
{{ if .valid }}
<div class="validation-result validation-success" style="margin-top: 0.5rem; padding: 0.5rem; background: var(--success-bg); border-radius: var(--radius-sm); font-size: 0.875rem;">
    <span class="status-dot success" style="display: inline-block;"></span>
    <span>{{ .message }}</span>
</div>
{{ else }}
<div class="validation-result validation-error" style="margin-top: 0.5rem; padding: 0.5rem; background: var(--error-bg); border-radius: var(--radius-sm); font-size: 0.875rem;">
    <span class="status-dot error" style="display: inline-block;"></span>
    <span>{{ .error }}</span>
</div>
{{ end }}
{{ end }}
