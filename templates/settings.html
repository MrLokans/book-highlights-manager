{{ define "settings" }}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Highlights</title>
    <script src="https://unpkg.com/htmx.org@2.0.4"></script>
    <link rel="stylesheet" href="/static/style.css">
    {{ if .Auth.CSRFToken }}
    <meta name="csrf-token" content="{{ .Auth.CSRFToken }}">
    {{ end }}
</head>
<body>
    {{ template "demo-banner" . }}
    <div class="container">
        <header>
            <div class="header-row">
                <h1><a href="/">Highlights</a></h1>
                {{ if .Auth.Enabled }}
                <div class="user-menu">
                    {{ if .Auth.LoggedIn }}
                    <span class="user-name">{{ .Auth.Username }}</span>
                    <a href="/profile" class="profile-link">Profile</a>
                    <a href="/logout" class="logout-link">Logout</a>
                    {{ else }}
                    <a href="/login" class="login-link">Login</a>
                    {{ end }}
                </div>
                {{ end }}
            </div>
            <nav>
                <a href="/">Books</a>
                <a href="/favourites">Favourites</a>
                <a href="/vocabulary">Vocabulary</a>
                {{ if not .Demo.Enabled }}<a href="/settings" class="active">Settings</a>{{ end }}
            </nav>
        </header>

        <h2 class="page-title">Settings</h2>

        <div class="settings-tabs-container">
            <nav class="settings-tabs">
                <button class="settings-tab active" data-tab="integrations">
                    <svg class="settings-tab-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M18 20V10"/>
                        <path d="M12 20V4"/>
                        <path d="M6 20v-6"/>
                    </svg>
                    Integrations
                </button>
                <button class="settings-tab" data-tab="exports">
                    <svg class="settings-tab-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                        <polyline points="10 9 9 9 8 9"/>
                    </svg>
                    Exports
                </button>
                <button class="settings-tab" data-tab="admin">
                    <svg class="settings-tab-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                    Admin
                </button>
            </nav>

            <div class="settings-tab-content">
                <div id="tab-integrations" class="settings-tab-panel active">
                    <section class="settings-section">
                        <h3>Integrations</h3>

                        <div class="integration-card">
                <div class="integration-header">
                    <div class="integration-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.6 0 12 0zm-2.2 17.8l-3.4-3.4 1.4-1.4 2 2 5.6-5.6 1.4 1.4-7 7z"/>
                        </svg>
                    </div>
                    <div class="integration-info">
                        <h4>Dropbox</h4>
                        <p class="integration-desc">Sync Moon+ Reader highlights from Dropbox</p>
                    </div>
                </div>

                {{ if not .DropboxConfigured }}
                <div class="integration-status status-error">
                    <span class="status-icon">!</span>
                    <span>App Key not configured. Set DROPBOX_APP_KEY environment variable.</span>
                </div>
                {{ else }}
                <div id="dropbox-status-container">
                    {{ template "dropbox-status" .DropboxStatus }}
                </div>
                {{ end }}
            </div>

            <div class="integration-card">
                <div class="integration-header">
                    <div class="integration-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                        </svg>
                    </div>
                    <div class="integration-info">
                        <h4>Readwise CSV</h4>
                        <p class="integration-desc">Import highlights from Readwise CSV export</p>
                    </div>
                </div>

                <div class="integration-status status-info">
                    <span class="status-dot info"></span>
                    <span class="status-text">Upload your Readwise CSV export file</span>
                </div>
                <div class="integration-actions">
                    <form
                        hx-post="/settings/readwise/import-csv"
                        hx-target="#readwise-csv-result-container"
                        hx-swap="innerHTML"
                        hx-encoding="multipart/form-data"
                        hx-indicator="#readwise-csv-indicator"
                    >
                        <div class="file-upload-container">
                            <input type="file" name="csv_file" id="readwise-csv-file" accept=".csv" required>
                            <label for="readwise-csv-file" class="file-upload-label">Choose CSV file</label>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <span id="readwise-csv-indicator" class="htmx-indicator">
                                <span class="spinner"></span>
                            </span>
                            Import CSV
                        </button>
                    </form>
                </div>
                <div id="readwise-csv-result-container"></div>
            </div>

            <div class="integration-card">
                <div class="integration-header">
                    <div class="integration-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M21 5c-1.11-.35-2.33-.5-3.5-.5-1.95 0-4.05.4-5.5 1.5-1.45-1.1-3.55-1.5-5.5-1.5S2.45 4.9 1 6v14.65c0 .25.25.5.5.5.1 0 .15-.05.25-.05C3.1 20.45 5.05 20 6.5 20c1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.3 4.75 1.05.1.05.15.05.25.05.25 0 .5-.25.5-.5V6c-.6-.45-1.25-.75-2-1zm0 13.5c-1.1-.35-2.3-.5-3.5-.5-1.7 0-4.15.65-5.5 1.5V8c1.35-.85 3.8-1.5 5.5-1.5 1.2 0 2.4.15 3.5.5v11.5z"/>
                        </svg>
                    </div>
                    <div class="integration-info">
                        <h4>Apple Books</h4>
                        <p class="integration-desc">Import highlights from Apple Books SQLite databases</p>
                    </div>
                </div>

                <div class="integration-status status-info">
                    <span class="status-dot info"></span>
                    <span class="status-text">Upload your Apple Books database files from macOS</span>
                </div>
                <details class="integration-help">
                    <summary>How to find your Apple Books databases</summary>
                    <div class="help-content">
                        <p>On macOS, your Apple Books databases are located at:</p>
                        <ul>
                            <li><strong>Annotations:</strong> <code>~/Library/Containers/com.apple.iBooksX/Data/Documents/AEAnnotation/*.sqlite</code></li>
                            <li><strong>Books:</strong> <code>~/Library/Containers/com.apple.iBooksX/Data/Documents/BKLibrary/*.sqlite</code></li>
                        </ul>
                        <p>You can access these folders in Finder by pressing <kbd>Cmd+Shift+G</kbd> and pasting the path.</p>
                    </div>
                </details>
                <div class="integration-actions">
                    <form
                        hx-post="/settings/applebooks/import"
                        hx-target="#applebooks-result-container"
                        hx-swap="innerHTML"
                        hx-encoding="multipart/form-data"
                        hx-indicator="#applebooks-indicator"
                    >
                        <div class="file-upload-group">
                            <div class="file-upload-container">
                                <label class="file-upload-title">Annotation Database</label>
                                <input type="file" name="annotation_db" id="applebooks-annotation-file" accept=".sqlite,.db" required>
                                <label for="applebooks-annotation-file" class="file-upload-label">Choose annotation .sqlite</label>
                            </div>
                            <div class="file-upload-container">
                                <label class="file-upload-title">Book Database</label>
                                <input type="file" name="book_db" id="applebooks-book-file" accept=".sqlite,.db" required>
                                <label for="applebooks-book-file" class="file-upload-label">Choose book .sqlite</label>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <span id="applebooks-indicator" class="htmx-indicator">
                                <span class="spinner"></span>
                            </span>
                            Import from Apple Books
                        </button>
                    </form>
                </div>
                <div id="applebooks-result-container"></div>
            </div>

            <div class="integration-card">
                <div class="integration-header">
                    <div class="integration-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M17.5 4.5c-1.95 0-4.05.4-5.5 1.5-1.45-1.1-3.55-1.5-5.5-1.5-1.45 0-2.99.22-4.28.79C1.49 5.62 1 6.33 1 7.14v11.28c0 1.3 1.22 2.26 2.48 1.94.98-.25 2.02-.36 3.02-.36 1.56 0 3.22.26 4.56.92.6.3 1.28.3 1.88 0 1.34-.67 3-.92 4.56-.92 1 0 2.04.11 3.02.36 1.26.33 2.48-.63 2.48-1.94V7.14c0-.81-.49-1.52-1.22-1.85-1.29-.57-2.83-.79-4.28-.79zM21 17.23c0 .63-.58 1.09-1.2.98-.75-.14-1.53-.21-2.3-.21-1.7 0-4.15.65-5.5 1.5V8c1.35-.85 3.8-1.5 5.5-1.5.92 0 1.83.09 2.7.28.46.1.8.51.8.98v9.47z"/>
                        </svg>
                    </div>
                    <div class="integration-info">
                        <h4>Kindle</h4>
                        <p class="integration-desc">Import highlights from Kindle 'My Clippings.txt'</p>
                    </div>
                </div>

                <div class="integration-status status-info">
                    <span class="status-dot info"></span>
                    <span class="status-text">Upload your Kindle clippings file</span>
                </div>
                <details class="integration-help">
                    <summary>How to find your Kindle clippings file</summary>
                    <div class="help-content">
                        <p>When your Kindle is connected to your computer, the clippings file is located at:</p>
                        <ul>
                            <li><strong>macOS:</strong> <code>/Volumes/Kindle/documents/My Clippings.txt</code></li>
                            <li><strong>Windows:</strong> <code>D:\documents\My Clippings.txt</code> (drive letter may vary)</li>
                            <li><strong>Linux:</strong> <code>/media/&lt;user&gt;/Kindle/documents/My Clippings.txt</code></li>
                        </ul>
                        <p>This file contains all your highlights, notes, and bookmarks from all books on your Kindle device.</p>
                    </div>
                </details>
                <div class="integration-actions">
                    <form
                        hx-post="/settings/kindle/import"
                        hx-target="#kindle-result-container"
                        hx-swap="innerHTML"
                        hx-encoding="multipart/form-data"
                        hx-indicator="#kindle-indicator"
                    >
                        <div class="file-upload-container">
                            <input type="file" name="clippings_file" id="kindle-clippings-file" accept=".txt" required>
                            <label for="kindle-clippings-file" class="file-upload-label">Choose My Clippings.txt</label>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <span id="kindle-indicator" class="htmx-indicator">
                                <span class="spinner"></span>
                            </span>
                            Import from Kindle
                        </button>
                    </form>
                </div>
                <div id="kindle-result-container"></div>
            </div>
                    </section>
                </div>

                <div id="tab-exports" class="settings-tab-panel">
                    <section class="settings-section">
                        <h3>Exports</h3>

                        <div class="integration-card">
                            <div class="integration-header">
                                <div class="integration-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                        <polyline points="14 2 14 8 20 8"/>
                                        <line x1="16" y1="13" x2="8" y2="13"/>
                                        <line x1="16" y1="17" x2="8" y2="17"/>
                                        <polyline points="10 9 9 9 8 9"/>
                                    </svg>
                                </div>
                                <div class="integration-info">
                                    <h4>Markdown (Obsidian) Export</h4>
                                    <p class="integration-desc">Export highlights as Markdown files to your Obsidian vault</p>
                                </div>
                            </div>

                            <div id="export-path-container">
                                {{ template "export-path-form" . }}
                            </div>
                        </div>
                    </section>
                </div>

                <div id="tab-admin" class="settings-tab-panel">
                    <section class="settings-section">
                        <h3>Administrative Tasks</h3>

                        <div class="integration-card">
                            <div class="integration-header">
                                <div class="integration-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="12" cy="12" r="10"/>
                                        <line x1="12" y1="8" x2="12" y2="12"/>
                                        <line x1="12" y1="16" x2="12.01" y2="16"/>
                                    </svg>
                                </div>
                                <div class="integration-info">
                                    <h4>Sync Book Metadata</h4>
                                    <p class="integration-desc">Fetch missing metadata (covers, publishers, publication years) from OpenLibrary for all books</p>
                                </div>
                            </div>

                            <div class="integration-status status-info">
                                <span class="status-dot info"></span>
                                <span class="status-text">This will process all books missing cover images, publisher info, or publication year</span>
                            </div>
                            <div class="integration-actions">
                                <div id="sync-status" hx-get="/api/sync/metadata/status" hx-trigger="load" hx-swap="outerHTML">
                                    <button
                                        class="btn btn-primary"
                                        hx-post="/api/books/enrich-all"
                                        hx-target="#sync-status"
                                        hx-swap="outerHTML"
                                        hx-confirm="This will fetch metadata for all books missing data. Continue?"
                                    >
                                        Sync All Missing Metadata
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="integration-card">
                            <div class="integration-header">
                                <div class="integration-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/>
                                        <line x1="7" y1="7" x2="7.01" y2="7"/>
                                    </svg>
                                </div>
                                <div class="integration-info">
                                    <h4>Cleanup Orphan Tags</h4>
                                    <p class="integration-desc">Remove tags that are not associated with any books or highlights</p>
                                </div>
                            </div>

                            <div class="integration-status status-info">
                                <span class="status-dot info"></span>
                                <span class="status-text">This will permanently delete unused tags from the database</span>
                            </div>
                            <div class="integration-actions">
                                <div id="tags-cleanup-container">
                                    <button
                                        class="btn btn-primary"
                                        hx-post="/api/admin/tags/cleanup"
                                        hx-target="#tags-cleanup-container"
                                        hx-swap="innerHTML"
                                        hx-indicator="#tags-cleanup-indicator"
                                        hx-confirm="This will delete all tags not linked to any book or highlight. Continue?"
                                    >
                                        <span id="tags-cleanup-indicator" class="htmx-indicator">
                                            <span class="spinner"></span>
                                        </span>
                                        Cleanup Orphan Tags
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="integration-card">
                            <div class="integration-header">
                                <div class="integration-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <rect x="2" y="7" width="20" height="14" rx="2" ry="2"/>
                                        <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>
                                    </svg>
                                </div>
                                <div class="integration-info">
                                    <h4>Background Tasks</h4>
                                    <p class="integration-desc">Manually trigger background tasks</p>
                                </div>
                            </div>

                            <div class="integration-status status-info">
                                <span class="status-dot info"></span>
                                <span class="status-text">{{ if .TasksEnabled }}Task queue is running with {{ .TaskWorkers }} workers{{ else }}Task queue is disabled{{ end }}</span>
                            </div>
                            {{ if .TasksEnabled }}
                            <div class="integration-actions">
                                <div id="task-enrich-book-container">
                                    <div class="task-action-row">
                                        <form
                                            hx-post="/api/tasks/enrich_book/run"
                                            hx-target="#task-enrich-book-result"
                                            hx-swap="innerHTML"
                                            hx-indicator="#task-enrich-book-indicator"
                                            class="task-form"
                                        >
                                            <input type="number" name="book_id" placeholder="Book ID" class="form-input task-input" required min="1">
                                            <button type="submit" class="btn btn-secondary">
                                                <span id="task-enrich-book-indicator" class="htmx-indicator">
                                                    <span class="spinner"></span>
                                                </span>
                                                Enrich Single Book
                                            </button>
                                        </form>
                                    </div>
                                    <div id="task-enrich-book-result"></div>
                                </div>
                                <div id="task-enrich-all-container" style="margin-top: 0.5rem;">
                                    <button
                                        class="btn btn-secondary"
                                        hx-post="/api/tasks/enrich_all_books/run"
                                        hx-target="#task-enrich-all-result"
                                        hx-swap="innerHTML"
                                        hx-indicator="#task-enrich-all-indicator"
                                        hx-confirm="This will enqueue enrichment tasks for all books missing metadata. Continue?"
                                    >
                                        <span id="task-enrich-all-indicator" class="htmx-indicator">
                                            <span class="spinner"></span>
                                        </span>
                                        Enqueue All Missing (via Task Queue)
                                    </button>
                                    <div id="task-enrich-all-result"></div>
                                </div>
                            </div>
                            {{ end }}
                        </div>
                    </section>
                </div>
            </div>
        </div>

        <script>
            document.querySelectorAll('.settings-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.settings-tab-panel').forEach(p => p.classList.remove('active'));

                    tab.classList.add('active');
                    const tabId = tab.getAttribute('data-tab');
                    document.getElementById('tab-' + tabId).classList.add('active');
                });
            });

            // Configure HTMX to include CSRF token in all non-GET requests
            document.body.addEventListener('htmx:configRequest', function(evt) {
                const csrfMeta = document.querySelector('meta[name="csrf-token"]');
                if (csrfMeta && evt.detail.verb !== 'get') {
                    evt.detail.headers['X-CSRF-Token'] = csrfMeta.content;
                }
            });

        </script>
        {{ template "demo-banner-script" . }}
    </div>
</body>
</html>
{{ end }}

{{ define "export-path-form" }}
<div class="export-settings">
    <form
        hx-post="/settings/export/markdown/save"
        hx-target="#export-path-container"
        hx-swap="innerHTML"
    >
        <div class="form-group">
            <label for="export-path">Export Directory</label>
            <div class="input-with-badge">
                <input
                    type="text"
                    id="export-path"
                    name="path"
                    value="{{ .ExportPath }}"
                    placeholder="/path/to/obsidian/vault"
                    class="form-input"
                >
                {{ if eq .ExportPathSource "database" }}
                <span class="badge badge-success">Saved</span>
                {{ else if eq .ExportPathSource "environment" }}
                <span class="badge badge-info">From ENV</span>
                {{ else }}
                <span class="badge badge-default">Default</span>
                {{ end }}
            </div>
            <small class="form-help">
                {{ if eq .ExportPathSource "database" }}
                Custom path saved in database
                {{ else if eq .ExportPathSource "environment" }}
                Using OBSIDIAN_VAULT_DIR environment variable
                {{ else }}
                Using current working directory
                {{ end }}
            </small>
        </div>
        <div class="form-group checkbox-group">
            <label class="checkbox-label">
                <input type="checkbox" name="create_dirs" value="true">
                <span>Create directories if they don't exist</span>
            </label>
        </div>
        <div class="integration-actions">
            <button type="submit" class="btn btn-primary">Save Path</button>
            {{ if eq .ExportPathSource "database" }}
            <button
                type="button"
                class="btn btn-secondary"
                hx-post="/settings/export/markdown/reset"
                hx-target="#export-path-container"
                hx-swap="innerHTML"
                hx-confirm="Reset to default? This will use the environment variable or current directory."
            >
                Reset to Default
            </button>
            {{ end }}
        </div>
    </form>
</div>
{{ end }}

{{ define "export-path-result" }}
{{ if .Success }}
<div class="export-settings">
    <div class="import-result import-success" style="margin-bottom: 1rem;">
        <div class="import-result-header">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                <polyline points="22 4 12 14.01 9 11.01"/>
            </svg>
            <span>Settings saved</span>
        </div>
    </div>
    <form
        hx-post="/settings/export/markdown/save"
        hx-target="#export-path-container"
        hx-swap="innerHTML"
    >
        <div class="form-group">
            <label for="export-path">Export Directory</label>
            <div class="input-with-badge">
                <input
                    type="text"
                    id="export-path"
                    name="path"
                    value="{{ .Path }}"
                    placeholder="/path/to/obsidian/vault"
                    class="form-input"
                >
                {{ if eq .Source "database" }}
                <span class="badge badge-success">Saved</span>
                {{ else if eq .Source "environment" }}
                <span class="badge badge-info">From ENV</span>
                {{ else }}
                <span class="badge badge-default">Default</span>
                {{ end }}
            </div>
            <small class="form-help">
                {{ if eq .Source "database" }}
                Custom path saved in database
                {{ else if eq .Source "environment" }}
                Using OBSIDIAN_VAULT_DIR environment variable
                {{ else }}
                Using current working directory
                {{ end }}
            </small>
        </div>
        <div class="form-group checkbox-group">
            <label class="checkbox-label">
                <input type="checkbox" name="create_dirs" value="true">
                <span>Create directories if they don't exist</span>
            </label>
        </div>
        <div class="integration-actions">
            <button type="submit" class="btn btn-primary">Save Path</button>
            {{ if eq .Source "database" }}
            <button
                type="button"
                class="btn btn-secondary"
                hx-post="/settings/export/markdown/reset"
                hx-target="#export-path-container"
                hx-swap="innerHTML"
                hx-confirm="Reset to default? This will use the environment variable or current directory."
            >
                Reset to Default
            </button>
            {{ end }}
        </div>
    </form>
</div>
{{ else }}
<div class="export-settings">
    <div class="import-result import-error" style="margin-bottom: 1rem;">
        <div class="import-result-header">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <line x1="15" y1="9" x2="9" y2="15"/>
                <line x1="9" y1="9" x2="15" y2="15"/>
            </svg>
            <span>{{ .Error }}</span>
        </div>
    </div>
    <form
        hx-post="/settings/export/markdown/save"
        hx-target="#export-path-container"
        hx-swap="innerHTML"
    >
        <div class="form-group">
            <label for="export-path">Export Directory</label>
            <div class="input-with-badge">
                <input
                    type="text"
                    id="export-path"
                    name="path"
                    value="{{ .Path }}"
                    placeholder="/path/to/obsidian/vault"
                    class="form-input"
                >
            </div>
        </div>
        <div class="form-group checkbox-group">
            <label class="checkbox-label">
                <input type="checkbox" name="create_dirs" value="true">
                <span>Create directories if they don't exist</span>
            </label>
        </div>
        <div class="integration-actions">
            <button type="submit" class="btn btn-primary">Save Path</button>
        </div>
    </form>
</div>
{{ end }}
{{ end }}

{{ define "dropbox-status" }}
{{ if .Connected }}
<div class="integration-status status-connected">
    <span class="status-dot connected"></span>
    <div class="status-details">
        <span class="status-text">Connected</span>
        {{ if .DisplayName }}
        <span class="status-account">{{ .DisplayName }}</span>
        {{ else if .Email }}
        <span class="status-account">{{ .Email }}</span>
        {{ else if .AccountID }}
        <span class="status-account">{{ .AccountID }}</span>
        {{ end }}
        {{ if .IsExpired }}
        <span class="status-warning">Token expired - reconnect required</span>
        {{ end }}
    </div>
</div>
<div class="integration-actions">
    {{ if not .IsExpired }}
    <button
        class="btn btn-primary"
        hx-post="/settings/moonreader/import"
        hx-target="#import-result-container"
        hx-swap="innerHTML"
        hx-indicator="#import-indicator"
    >
        <span id="import-indicator" class="htmx-indicator">
            <span class="spinner"></span>
        </span>
        Import Moon+ Reader Backup
    </button>
    {{ end }}
    <button
        class="btn btn-secondary"
        hx-post="/settings/oauth/dropbox/check"
        hx-target="#dropbox-status-container"
        hx-swap="innerHTML"
        hx-indicator="#dropbox-check-indicator"
    >
        <span id="dropbox-check-indicator" class="htmx-indicator">
            <span class="spinner"></span>
        </span>
        Check Token
    </button>
    <button
        class="btn btn-danger"
        hx-post="/settings/oauth/dropbox/disconnect"
        hx-target="#dropbox-status-container"
        hx-swap="innerHTML"
        hx-confirm="Are you sure you want to disconnect Dropbox?"
    >
        Disconnect
    </button>
</div>
<div id="import-result-container"></div>
{{ else }}
<div class="integration-status status-disconnected">
    <span class="status-dot disconnected"></span>
    <span class="status-text">Not connected</span>
</div>
<div class="integration-actions">
    <form action="/settings/oauth/dropbox/init" method="POST">
        <button type="submit" class="btn btn-primary">
            Connect Dropbox
        </button>
    </form>
</div>
{{ end }}
{{ end }}

{{ define "settings-callback" }}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dropbox Authorization - Highlights</title>
    <link rel="stylesheet" href="/static/style.css">
    {{ if .Success }}
    <meta http-equiv="refresh" content="3;url=/settings">
    {{ end }}
</head>
<body>
    <div class="container">
        <header>
            <h1><a href="/">Highlights</a></h1>
            <nav>
                <a href="/">Books</a>
                <a href="/settings">Settings</a>
            </nav>
        </header>

        <div class="callback-result">
            {{ if .Success }}
            <div class="callback-success">
                <div class="callback-icon success">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                        <polyline points="22 4 12 14.01 9 11.01"/>
                    </svg>
                </div>
                <h2>Dropbox Connected!</h2>
                <p>Successfully connected to Dropbox account.</p>
                {{ if .AccountID }}
                <p class="account-id">Account: {{ .AccountID }}</p>
                {{ end }}
                <p class="redirect-notice">Redirecting to settings...</p>
                <a href="/settings" class="btn btn-primary">Go to Settings</a>
            </div>
            {{ else }}
            <div class="callback-error">
                <div class="callback-icon error">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="15" y1="9" x2="9" y2="15"/>
                        <line x1="9" y1="9" x2="15" y2="15"/>
                    </svg>
                </div>
                <h2>Authorization Failed</h2>
                <p class="error-message">{{ .Error }}</p>
                <a href="/settings" class="btn btn-primary">Back to Settings</a>
            </div>
            {{ end }}
        </div>
    </div>
</body>
</html>
{{ end }}

{{ define "settings-error" }}
<div class="integration-status status-error">
    <span class="status-icon">!</span>
    <span>{{ .Error }}</span>
</div>
{{ end }}

{{ define "import-result" }}
{{ if .Success }}
<div class="import-result import-success">
    <div class="import-result-header">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
        </svg>
        <span>Import Successful</span>
    </div>
    <div class="import-stats">
        <div class="import-stat">
            <span class="stat-value">{{ .Highlights }}</span>
            <span class="stat-label">highlights</span>
        </div>
        <div class="import-stat">
            <span class="stat-value">{{ .BooksImported }}</span>
            <span class="stat-label">books imported</span>
        </div>
        <div class="import-stat">
            <span class="stat-value">{{ .BooksExported }}</span>
            <span class="stat-label">books exported</span>
        </div>
    </div>
    {{ if .Errors }}
    <div class="import-warnings">
        <strong>Warnings:</strong>
        <ul>
            {{ range .Errors }}
            <li>{{ . }}</li>
            {{ end }}
        </ul>
    </div>
    {{ end }}
</div>
{{ else }}
<div class="import-result import-error">
    <div class="import-result-header">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"/>
            <line x1="15" y1="9" x2="9" y2="15"/>
            <line x1="9" y1="9" x2="15" y2="15"/>
        </svg>
        <span>Import Failed</span>
    </div>
    <p class="import-error-message">{{ .Error }}</p>
</div>
{{ end }}
{{ end }}

{{ define "readwise-csv-import-result" }}
{{ if .Success }}
<div class="import-result import-success">
    <div class="import-result-header">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
        </svg>
        <span>CSV Import Successful</span>
    </div>
    <div class="import-stats">
        <div class="import-stat">
            <span class="stat-value">{{ .TotalRows }}</span>
            <span class="stat-label">rows processed</span>
        </div>
        <div class="import-stat">
            <span class="stat-value">{{ .BooksImported }}</span>
            <span class="stat-label">books</span>
        </div>
        <div class="import-stat">
            <span class="stat-value">{{ .HighlightsImported }}</span>
            <span class="stat-label">highlights</span>
        </div>
    </div>
    {{ if .Errors }}
    <div class="import-warnings">
        <strong>Warnings:</strong>
        <ul>
            {{ range .Errors }}
            <li>{{ . }}</li>
            {{ end }}
        </ul>
    </div>
    {{ end }}
</div>
{{ else }}
<div class="import-result import-error">
    <div class="import-result-header">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"/>
            <line x1="15" y1="9" x2="9" y2="15"/>
            <line x1="9" y1="9" x2="15" y2="15"/>
        </svg>
        <span>Import Failed</span>
    </div>
    <p class="import-error-message">{{ .Error }}</p>
</div>
{{ end }}
{{ end }}

{{ define "applebooks-import-result" }}
{{ if .Success }}
<div class="import-result import-success">
    <div class="import-result-header">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
        </svg>
        <span>Apple Books Import Successful</span>
    </div>
    <div class="import-stats">
        <div class="import-stat">
            <span class="stat-value">{{ .BooksImported }}</span>
            <span class="stat-label">books</span>
        </div>
        <div class="import-stat">
            <span class="stat-value">{{ .HighlightsImported }}</span>
            <span class="stat-label">highlights</span>
        </div>
    </div>
    {{ if .Errors }}
    <div class="import-warnings">
        <strong>Warnings:</strong>
        <ul>
            {{ range .Errors }}
            <li>{{ . }}</li>
            {{ end }}
        </ul>
    </div>
    {{ end }}
</div>
{{ else }}
<div class="import-result import-error">
    <div class="import-result-header">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"/>
            <line x1="15" y1="9" x2="9" y2="15"/>
            <line x1="9" y1="9" x2="15" y2="15"/>
        </svg>
        <span>Import Failed</span>
    </div>
    <p class="import-error-message">{{ .Error }}</p>
</div>
{{ end }}
{{ end }}

{{ define "kindle-import-result" }}
{{ if .Success }}
<div class="import-result import-success">
    <div class="import-result-header">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
        </svg>
        <span>Kindle Import Successful</span>
    </div>
    <div class="import-stats">
        <div class="import-stat">
            <span class="stat-value">{{ .BooksImported }}</span>
            <span class="stat-label">books</span>
        </div>
        <div class="import-stat">
            <span class="stat-value">{{ .HighlightsImported }}</span>
            <span class="stat-label">highlights</span>
        </div>
    </div>
    {{ if .Errors }}
    <div class="import-warnings">
        <strong>Warnings:</strong>
        <ul>
            {{ range .Errors }}
            <li>{{ . }}</li>
            {{ end }}
        </ul>
    </div>
    {{ end }}
</div>
{{ else }}
<div class="import-result import-error">
    <div class="import-result-header">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"/>
            <line x1="15" y1="9" x2="9" y2="15"/>
            <line x1="9" y1="9" x2="15" y2="15"/>
        </svg>
        <span>Import Failed</span>
    </div>
    <p class="import-error-message">{{ .Error }}</p>
</div>
{{ end }}
{{ end }}

{{ define "task-run-result" }}
{{ if .Success }}
<div class="import-result import-success" style="margin-top: 0.5rem;">
    <div class="import-result-header">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
        </svg>
        <span>Task Enqueued</span>
    </div>
    <p class="task-id">Task ID: {{ .TaskID }}</p>
</div>
{{ else }}
<div class="import-result import-error" style="margin-top: 0.5rem;">
    <div class="import-result-header">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"/>
            <line x1="15" y1="9" x2="9" y2="15"/>
            <line x1="9" y1="9" x2="15" y2="15"/>
        </svg>
        <span>Failed</span>
    </div>
    <p class="import-error-message">{{ .Error }}</p>
</div>
{{ end }}
{{ end }}

{{ define "tags-cleanup-result" }}
{{ if .Success }}
<div class="import-result import-success">
    <div class="import-result-header">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
        </svg>
        <span>Cleanup Complete</span>
    </div>
    <div class="import-stats">
        <div class="import-stat">
            <span class="stat-value">{{ .Deleted }}</span>
            <span class="stat-label">tags removed</span>
        </div>
    </div>
</div>
{{ else }}
<div class="import-result import-error">
    <div class="import-result-header">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"/>
            <line x1="15" y1="9" x2="9" y2="15"/>
            <line x1="9" y1="9" x2="15" y2="15"/>
        </svg>
        <span>Cleanup Failed</span>
    </div>
    <p class="import-error-message">{{ .Error }}</p>
</div>
{{ end }}
{{ end }}
